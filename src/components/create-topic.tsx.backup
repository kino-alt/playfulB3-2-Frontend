"use client"

import { useState, useEffect, use, useRef } from "react"
import { GameButton } from "./game-button"
import { EmojiBackgroundLayout } from "./emoji-background-layout"
import { PageHeader } from "./page-header"
import { TextInput } from "./text-input"
import { TextDisplay} from "./text-display"
import { DisplaySelectedEmojis } from "./display-selected-emojis"
import { useRouter } from "next/navigation"
import { Modal } from "./modal"
//FIX: Add
import { useRoomData } from '@/contexts/room-context';
import { GameState } from "@/contexts/types";
import EmojiPicker, { EmojiClickData, Theme } from 'emoji-picker-react';


export function CreateTopic() {
Â  const [topicInput, setTopicInput] = useState("")
Â  const [emojiInput, setEmojiInput] = useState("")
Â  const [localSelectedEmojis, setLocalSelectedEmojis] = useState<string[]>([])
Â  const [showHintOverlay, setShowHintOverlay] = useState(false)
Â  const [showPicker, setShowPicker] = useState(false)
Â  const router = useRouter()
Â  const { 
Â  Â  roomId,
Â  Â  roomCode,
Â  Â  theme, 
Â  Â  hint, Â 
Â  Â  participantsList,
Â  Â  roomState,
Â  Â  maxEmojis,
Â  Â  submitTopic,
Â  Â  globalError,
Â  } = useRoomData();
Â  
Â  const pickerRef = useRef<HTMLDivElement>(null);
Â  
Â  // push next page
Â  useEffect(() => {
Â  Â  console.log("Current Room State:", roomState); // ãƒ‡ãƒãƒƒã‚°ç”¨
Â  Â  if (roomState === GameState.DISCUSSING && roomCode) {
Â  Â  Â  console.log("Navigating to discussion-time...");
Â  Â  Â  router.push(`/room/${roomId}/waiting-discussion-time`);
Â  Â  }
Â  }, [roomState, roomId, router])

Â  const onEmojiClick = (emojiData: EmojiClickData) => {
Â  Â  setEmojiInput(emojiData.emoji);
Â  Â  setShowPicker(false); // é¸æŠã—ãŸã‚‰é–‰ã˜ã‚‹
Â  };

Â  {/* Toggle hint overlay visibility */}
Â  const handleToggleHintOverlay = () => {
Â  Â  setShowHintOverlay(prev => !prev)
Â  }
Â  Â  
Â const handleAddEmoji = () => {
Â  Â  if (emojiInput && localSelectedEmojis.length < maxEmojis ) {
Â  Â  Â  setLocalSelectedEmojis([...localSelectedEmojis, emojiInput]);
Â  Â  Â  setEmojiInput(""); 
Â  Â  } else if (localSelectedEmojis.length >= maxEmojis) {
Â  Â  Â  alert(`çµµæ–‡å­—ã¯æœ€å¤§ ${maxEmojis} å€‹ã¾ã§ã—ã‹é¸æŠã§ãã¾ã›ã‚“ã€‚`);
Â  Â  }
Â  }

Â  const handleRemoveEmoji = (index: number) => {
Â  Â  setLocalSelectedEmojis(localSelectedEmojis.filter((_, i) => i !== index));
Â  }

Â  {/*submit handler */}
Â  const handleSubmit = async () => {
Â  Â  if (!topicInput) {
Â  Â  Â  alert(`ãŠé¡Œã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`);
Â  Â  Â  return;
Â  Â  }
Â  Â  if (localSelectedEmojis.length !== maxEmojis) {
      alert(`çµµæ–‡å­—ã‚’${maxEmojis} å€‹é¸æŠã—ã¦ãã ã•ã„ã€‚`);
      return;
    }
    try {
      console.log(`Submitting topic: ${topicInput} with emojis: ${localSelectedEmojis.join(', ')}`);
      await submitTopic(topicInput, localSelectedEmojis); 
    } catch (error) {
      console.error("Error submitting topic:", error);
      alert("ãƒˆãƒ”ãƒƒã‚¯ã®æå‡ºã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
Â  Â  Â  {/* Hint Modal */}
Â  Â  Â  <Modal
Â  Â  Â  Â  isOpen={showHintOverlay} 
Â  Â  Â  Â  onClose={handleToggleHintOverlay}
Â  Â  Â  Â  title="ğŸ’¡ Hint for Choosing Emojis"
Â  Â  Â  Â  content={hint} 
Â  Â  Â  />

Â  Â  Â  <div className="w-full max-w-xs flex flex-col h-full">
Â  Â  Â  Â  <PageHeader title="Set the Topic" subtitle={`Set the topic and choose the emojis`} marginBottom="mb-2" />
Â  Â  Â  Â  
Â  Â  Â  Â  {/*Theme display*/}
Â  Â  Â  Â  <TextDisplay
Â  Â  Â  Â  Â  value={theme || "N/A"}
Â  Â  Â  Â  Â  inputtitle=""
Â  Â  Â  Â  Â  height="py-0.5"
Â  Â  Â  Â  Â  variant="primary"
Â  Â  Â  Â  Â  textSize="text-sm"
Â  Â  Â  Â  Â  marginBottom="mb-2"
Â  Â  Â  Â  />

Â  Â  Â  Â  {/*Topic input*/}
Â  Â  Â  Â  <TextInput
Â  Â  Â  Â  Â  value={topicInput}
Â  Â  Â  Â  Â  onChange={setTopicInput}
Â  Â  Â  Â  Â  placeholder="Enter the Topic"
Â  Â  Â  Â  Â  height="py-2"
Â  Â  Â  Â  Â  variant="primary"
Â  Â  Â  Â  Â  textSize="text-lg"
Â  Â  Â  Â  Â  marginBottom="mb-6"
Â  Â  Â  Â  Â  uppercase={false}
Â  Â  Â  Â  Â  maxLength={50}
Â  Â  Â  Â  />

Â  Â  Â  Â  <div className="flex items-end justify-center gap-3 mb-8 ml-13">
Â  Â  Â  Â  Â  <div className="relative w-24 h-24">
Â  Â  Â  Â  Â  Â  {/* Hint Overlay Button */}
Â  Â  Â  Â  Â  Â  <button
              onClick={handleToggleHintOverlay}
              className="absolute top-2 -left-9 z-10 w-6 h-6 rounded-full bg-yellow-400 text-white font-bold flex items-center justify-center text-sm shadow-md hover:bg-yellow-500 transition-colors"
              title="Refer to Hints"
            >
              !
Â  Â  Â  Â  Â  Â  Â  Â  value={emojiInput}
Â  Â  Â  Â  Â  Â  Â  Â  onChange={() => {}} // readOnlyãªã®ã§ä½•ã‚‚ã—ãªã„
Â  Â  Â  Â  Â  Â  Â  Â  inputtitle="" 
Â  Â  Â  Â  Â  Â  Â  Â  placeholder=""
Â  Â  Â  Â  Â  Â  Â  Â  height="py-8"
Â  Â  Â  Â  Â  Â  Â  Â  variant="gray"
Â  Â  Â  Â  Â  Â  Â  Â  mode="edit"
Â  Â  Â  Â  Â  Â  Â  Â  textSize="text-2xl"
Â  Â  Â  Â  Â  Â  Â  Â  marginBottom="mb-2"
Â  Â  Â  Â  Â  Â  Â  Â  isEmojiInput={true}
Â  Â  Â  Â  Â  Â  Â  Â  // @ts-ignore (TextInputã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒPropsã‚’å—ã‘å–ã‚Œã‚‹å ´åˆ)
Â  Â  Â  Â  Â  Â  Â  Â  readOnly={true} 
Â  Â  Â  Â  Â  Â  Â  />
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  {/* 5. çµµæ–‡å­—ãƒ”ãƒƒã‚«ãƒ¼ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤º */}
Â  Â  Â  Â  Â  Â  {showPicker && (
Â  Â  Â  Â  Â  Â  Â  <div className="fixed inset-0 z-40" onClick={() => setShowPicker(false)} />
Â  Â  Â  Â  Â  Â  )}
Â  Â  Â  Â  Â  Â  {showPicker && (
Â  Â  Â  Â  Â  Â  Â  <div className="absolute top-full mt-2 left-1/2 -translate-x-1/2 z-50 shadow-2xl">
Â  Â  Â  Â  Â  Â  Â  Â  <EmojiPicker 
Â  Â  Â  Â  Â  Â  Â  Â  Â  onEmojiClick={onEmojiClick}
Â  Â  Â  Â  Â  Â  Â  Â  Â  theme={Theme.LIGHT}
Â  Â  Â  Â  Â  Â  Â  Â  Â  autoFocusSearch={true}
Â  Â  Â  Â  Â  Â  Â  Â  Â  width={280}
Â  Â  Â  Â  Â  Â  Â  Â  Â  height={280}
Â  Â  Â  Â  Â  Â  Â  Â  Â  searchDisabled={false}
Â  Â  Â  Â  Â  Â  Â  Â  Â  skinTonesDisabled={true}
Â  Â  Â  Â  Â  Â  Â  Â  />
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  )}
Â  Â  Â  Â  Â  Â  <p className="text-xs text-gray-500 font-semibold uppercase text-center mt-2">Select Emoji</p>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â {/* Add button */}
Â  Â  Â  Â  Â  <div className="flex-shrink-0 mb-1"> 
Â  Â  Â  Â  Â  Â  <GameButton variant="secondary" onClick={handleAddEmoji} height="p-2" disabled={!emojiInput || localSelectedEmojis.length >= maxEmojis}> 
Â  Â  Â  Â  Â  Â  Â  <p className="text-xs font-bold uppercase"> ADD</p>
Â  Â  Â  Â  Â  Â  </GameButton>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  {/*display selected emojis*/}
Â  Â  Â  Â  <DisplaySelectedEmojis
Â  Â  Â  Â  Â  selectedEmojis={localSelectedEmojis}
Â  Â  Â  Â  Â  handleRemoveEmoji={handleRemoveEmoji}
Â  Â  Â  Â  Â  maxEmojis={maxEmojis}
Â  Â  Â  Â  Â  roomState={roomState}
Â  Â  Â  Â  />

Â  Â  Â  Â  {/*submit button*/}
Â  Â  Â  Â  <div className="mt-auto">
Â  Â  Â  Â  Â  <GameButton variant="primary" onClick={handleSubmit} >
Â  Â  Â  Â  Â  Â  Submit 
Â  Â  Â  Â  Â  </GameButton>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </EmojiBackgroundLayout>
Â  )
}